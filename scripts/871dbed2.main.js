"use strict";function resetMouseVars(){mousedown_node=null,mouseup_node=null,mousedown_link=null}function tick(){path.attr("d",function(a){var b=a.target.x-a.source.x,c=a.target.y-a.source.y,d=Math.sqrt(b*b+c*c),e=b/d,f=c/d,g=a.left?17:12,h=a.right?17:12,i=a.source.x+g*e,j=a.source.y+g*f,k=a.target.x-h*e,l=a.target.y-h*f;return"M"+i+","+j+"L"+k+","+l}),circle.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})}function restart(){path=path.data(links),path.classed("selected",function(a){return a===selected_link}).style("marker-start",function(a){return a.left?"url(#start-arrow)":""}).style("marker-end",function(a){return a.right?"url(#end-arrow)":""}),path.enter().append("svg:path").attr("class","link").classed("selected",function(a){return a===selected_link}).style("marker-start",function(a){return a.left?"url(#start-arrow)":""}).style("marker-end",function(a){return a.right?"url(#end-arrow)":""}).on("mousedown",function(a){d3.event.ctrlKey||(mousedown_link=a,selected_link=mousedown_link===selected_link?null:mousedown_link,restart())}),path.exit().remove(),circle=circle.data(nodes,function(a){return a.id}),circle.selectAll("circle").style("fill",function(a){return a===selected_node?d3.rgb(colors(a.id)).brighter().toString():colors(a.id)}).classed("reflexive",function(a){return a.reflexive});var a=circle.enter().append("svg:g");a.append("svg:circle").attr("class","node").attr("r",12).style("fill",function(a){return a===selected_node?d3.rgb(colors(a.id)).brighter().toString():colors(a.id)}).style("stroke",function(a){return d3.rgb(colors(a.id)).darker().toString()}).classed("reflexive",function(a){return a.reflexive}).on("mouseover",function(a){mousedown_node&&a!==mousedown_node&&d3.select(this).attr("transform","scale(1.1)")}).on("mouseout",function(a){mousedown_node&&a!==mousedown_node&&d3.select(this).attr("transform","")}).on("mousedown",function(a){d3.event.ctrlKey||(mousedown_node=a,selected_node=mousedown_node===selected_node?null:mousedown_node,selected_link=null,drag_line.style("marker-end","url(#end-arrow)").classed("hidden",!1).attr("d","M"+mousedown_node.x+","+mousedown_node.y+"L"+mousedown_node.x+","+mousedown_node.y),restart())}).on("mouseup",function(a){if(mousedown_node){if(drag_line.classed("hidden",!0).style("marker-end",""),mouseup_node=a,mouseup_node===mousedown_node)return void resetMouseVars();d3.select(this).attr("transform","");var b,c,d;mousedown_node.id<mouseup_node.id?(b=mousedown_node,c=mouseup_node,d="right"):(b=mouseup_node,c=mousedown_node,d="left");var e;e=links.filter(function(a){return a.source===b&&a.target===c})[0],e?e[d]=!0:(e={source:b,target:c,left:!1,right:!1},e[d]=!0,links.push(e)),selected_link=e,restart()}}),a.append("svg:text").attr("x",0).attr("y",4).attr("class","id").text(function(a){return a.id}),circle.exit().remove(),force.start()}function mousedown(){if(svg.classed("active",!0),!d3.event.ctrlKey&&!mousedown_link){if(mousedown_node)return current_function=0,void drawCurves();var a=d3.mouse(this),b={id:++lastNodeId,reflexive:!1,membership_functions:[]};b.x=a[0],b.y=a[1],nodes.push(b),restart()}}function mousemove(){mousedown_node&&(drag_line.attr("d","M"+mousedown_node.x+","+mousedown_node.y+"L"+d3.mouse(this)[0]+","+d3.mouse(this)[1]),restart())}function mouseup(){mousedown_node&&drag_line.classed("hidden",!0).style("marker-end",""),svg.classed("active",!1),resetMouseVars()}function spliceLinksForNode(a){var b=links.filter(function(b){return b.source===a||b.target===a});b.map(function(a){links.splice(links.indexOf(a),1)})}function keydown(){}function keyup(){}function drawCurves(){fillForm();var a=d3.select("#mf-list");a.selectAll("li").remove(),d3.select("#vis").selectAll("svg").remove(),selected_node.membership_functions.forEach(function(b,c){var d=a.append("li").append("button").attr("class","btn btn-default").text(c+1);if(c===current_function){d.attr("class","btn btn-success");var e="myCurve";d3.select("#vis").append("div").attr("id",e),bezier(selected_node.membership_functions[c],e)}$("#mf-list li button").click(function(){current_function=$(this).text()-1,drawCurves()})})}function fillForm(){if(selected_node.membership_functions.length>0){var a=selected_node.membership_functions[current_function];$("#titleField").val(a.title),$("#xAxisField").val(a.xLabel),$("#yAxisField").val(a.yLabel),$("#xMinField").val(a.xMin),$("#xMaxField").val(a.xMax),$("#yMinField").val(a.yMin),$("#yMaxField").val(a.yMax)}}function bezier(a,b){function c(){var b=t.selectAll("g").data(function(a){return e(a,l)});b.enter().append("g").style("fill",i).style("stroke",i),u=d3.scale.linear().domain([a.xMin,a.xMax]).range([0,j-2*n]),v=d3.scale.linear().domain([a.yMin,a.yMax]).range([k-2*n,0]);var c=d3.svg.axis(),d=d3.svg.axis().scale(v).orient("left");c.scale(u),d3.select("#vis").selectAll(".axis").remove(),d3.select("#vis").selectAll(".label").remove(),d3.select("#graphTitle").remove(),t.append("text").attr("x",j/2).attr("y",n).attr("text-anchor","middle").attr("id","graphTitle").style("font-size","16px").style("text-decoration","underline").text(a.title),t.append("g").attr("class","axis").attr("transform","translate("+n+","+(k-2*n)+")").call(c),t.append("g").attr("class","axis").attr("transform","translate("+n+", 0)").call(d),t.append("text").attr("class","label").attr("x",j/2-n).attr("y",k-n).style("text-anchor","middle").text(a.xLabel),t.append("text").attr("class","label").attr("transform","rotate(-90)").attr("x",n-k/2).attr("y",0).style("text-anchor","middle").text(a.yLabel);var m=t.selectAll("path.curve").data(f);m.enter().append("path").attr("class","curve"),m.attr("d",q),t.selectAll("circle.control").attr("cx",g).attr("cy",h),t.selectAll("text.controltext").attr("x",g).attr("y",h)}function d(a,b){arguments.length<2&&(b=l);for(var c=[],d=1;d<a.length;d++){var e=a[d-1],f=a[d];c.push({x:e.x+(f.x-e.x)*b,y:e.y+(f.y-e.y)*b})}return c}function e(a,b){arguments.length<2&&(b=l);for(var c=[o.slice(0,6)],e=1;a>e;e++)c.push(d(c[c.length-1],b));return c}function f(a){var b=p[a];if(!b){b=p[a]=[];for(var c=0;1>=c;c+=m){var d=e(a,c);b.push(d[d.length-1][0])}}return[b.slice(0,l/m+1)]}function g(a){return u(a.x)+n}function h(a){return v(a.y)}function i(a,b){return s(-b),a.length>1?s(b):"red"}var j=500,k=300,l=1,m=.01,n=30,o=a.points,p={},q=d3.svg.line().x(g).y(h),r=4,s=d3.scale.category20b(),t=(d3.range(2,r+2),d3.select("#"+b).selectAll("svg").data([5]).enter().append("svg").attr("width",j+2*n).attr("height",k+2*n).append("g").attr("transform","translate("+n+","+n+")")),u=d3.scale.linear().domain([a.xMin,a.xMax]).range([0,j-2*n]),v=d3.scale.linear().domain([a.yMin,a.yMax]).range([k-2*n,0]);c(),t.selectAll("circle.control").data(function(){return o.slice(0,6)}).enter().append("circle").attr("class","control").attr("r",7).attr("cx",function(a){return u(a.x)+n}).attr("cy",function(a){return v(a.y)}).call(d3.behavior.drag().on("dragstart",function(a){this.__origin__=[a.x,a.y]}).on("drag",function(b){var d=d3.scale.linear().domain([0,j-2*n]).range([a.xMin,a.xMax]),e=d3.scale.linear().domain([0,k-2*n]).range([a.yMin,a.yMax]);b.x=Math.min(a.xMax,Math.max(a.xMin,this.__origin__[0]+=d(d3.event.dx))),b.y=Math.min(a.yMax,Math.max(a.yMin,this.__origin__[1]-=e(d3.event.dy))),p={},c()}).on("dragend",function(){delete this.__origin__})),t.selectAll("text.controltext").data(function(){return o.slice(0,6)}).enter().append("text").attr("class","controltext").attr("dx","10px").attr("dy",".4em").text(function(a,b){return"P"+b});$(".mem-fn").keyup(function(){if(selected_node.membership_functions.length>0){var a=selected_node.membership_functions[current_function],b=$(this).attr("id").replace("Field","");"number"==typeof a[b]?(console.log("This is numeric"),a[b]=Number($(this).val())):(console.log("This is not numeric"),a[b]=$(this).val()),c()}})}var width=480,height=500,colors=d3.scale.category10(),svg=d3.select("#graph").append("svg").attr("width",width).attr("height",height),points=[],nodes=[],lastNodeId=-1,links=[],retrievedObject=localStorage.getItem("lastSessionData");if(null!==retrievedObject){var lastData=JSON.parse(retrievedObject);nodes=lastData.nodes,links=lastData.links;for(var i=0;i<links.length;i++)links[i].source=nodes[links[i].source.id],links[i].target=nodes[links[i].target.id];lastNodeId=Number(lastData.last)}var force=d3.layout.force().nodes(nodes).links(links).size([width,height]).linkDistance(150).charge(-500).on("tick",tick);svg.append("svg:defs").append("svg:marker").attr("id","end-arrow").attr("viewBox","0 -5 10 10").attr("refX",6).attr("markerWidth",3).attr("markerHeight",3).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5").attr("fill","#000"),svg.append("svg:defs").append("svg:marker").attr("id","start-arrow").attr("viewBox","0 -5 10 10").attr("refX",4).attr("markerWidth",3).attr("markerHeight",3).attr("orient","auto").append("svg:path").attr("d","M10,-5L0,0L10,5").attr("fill","#000");var drag_line=svg.append("svg:path").attr("class","link dragline hidden").attr("d","M0,0L0,0"),path=svg.append("svg:g").selectAll("path"),circle=svg.append("svg:g").selectAll("g"),selected_node=null,selected_link=null,mousedown_link=null,mousedown_node=null,mouseup_node=null,current_function=0,lastKeyDown=-1;svg.on("mousedown",mousedown).on("mousemove",mousemove).on("mouseup",mouseup),d3.select(window).on("keydown",keydown).on("keyup",keyup),restart(),$("#submitter").click(function(){console.log({nodes:nodes,links:links}),$.ajax({type:"POST",contentType:"application/json",url:"/",data:JSON.stringify({nodes:nodes,links:links}),dataType:"json"})}),$("#creator").click(function(){return null===selected_node?void alert("No node selected"):(selected_node.membership_functions.push({title:"Title",xLabel:"X Label",yLabel:"Y Label",xMin:0,xMax:100,yMin:0,yMax:1,points:[{x:0,y:0},{x:25,y:.25},{x:50,y:.5},{x:75,y:.75},{x:100,y:1}]}),current_function=selected_node.membership_functions.length-1,void drawCurves())}),$("#save").click(function(){alert("Session saved!"),localStorage.setItem("lastSessionData",JSON.stringify({nodes:nodes,links:links,last:lastNodeId}))}),$("#deleter").click(function(){for(var a=nodes.indexOf(selected_node),b=0;b<links.length;b++){var c=links[b];(c.source===selected_node||c.target===selected_node)&&(links.splice(b,1),b--)}nodes.splice(a,1),restart()});